<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
    --primary: #1a2238;
    --secondary: #9daaf2;
    --accent: #ff6a3d;
    --light: #f6f7fb;
    --dark: #1a2238;
    --success: #21e6c1;
    --warning: #ffd700;
    --card-bg: #fff;
    --shadow: 0 6px 24px rgba(26,34,56,0.08);
    --radius: 12px;
    --transition: 0.2s cubic-bezier(.4,0,.2,1);
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--light) 0%, #e3e6f3 100%);
    color: #222;
    min-height: 100vh;
}
.navbar {
    background: var(--primary);
    box-shadow: var(--shadow);
    border-bottom: 2px solid var(--secondary);
}
.navbar-brand {
    font-weight: 600;
    letter-spacing: 1px;
    font-size: 1.3rem;
}
.sidebar {
    background: var(--dark);
    color: #fff;
    min-height: 100vh;
    box-shadow: 2px 0 12px rgba(26,34,56,0.05);
    padding-top: 1rem;
}
.sidebar .nav-link {
    color: #c7d0e6;
    padding: 1rem 1.5rem;
    border-left: 4px solid transparent;
    font-size: 1.05rem;
    transition: background var(--transition), color var(--transition);
}
.sidebar .nav-link:hover,
.sidebar .nav-link.active {
    color: #fff;
    background: rgba(157,170,242,0.12);
    border-left-color: var(--secondary);
}
.card {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: none;
    transition: transform var(--transition), box-shadow var(--transition);
}
.card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 12px 32px rgba(26,34,56,0.12);
}
.btn-primary {
    background: linear-gradient(90deg, var(--secondary) 60%, var(--primary) 100%);
    border: none;
    color: #fff;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(157,170,242,0.12);
    transition: background var(--transition);
}
.btn-primary:hover {
    background: linear-gradient(90deg, var(--primary) 60%, var(--secondary) 100%);
}
.btn-danger {
    background: var(--accent);
    border: none;
    color: #fff;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(255,106,61,0.12);
    transition: background var(--transition);
}
.btn-danger:hover {
    background: #d94c2b;
}
.inventory-table th {
    background: var(--primary);
    color: #fff;
    font-weight: 600;
    letter-spacing: 0.5px;
}
.inventory-table td {
    vertical-align: middle;
}
.quantity-display {
    font-size: 1.2rem;
    font-weight: bold;
}
.category-badge {
    font-size: 0.85rem;
    padding: 0.35em 0.7em;
    background: var(--secondary);
    color: var(--primary);
    border-radius: 6px;
    font-weight: 500;
}
.page-content {
    display: none;
    animation: fadeIn 0.4s;
}
.page-content.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px);}
    to { opacity: 1; transform: none;}
}
.action-btn {
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin: 0 0.1rem;
    transition: background var(--transition), color var(--transition);
}
.add-btn {
    color: var(--success);
}
.remove-btn {
    color: var(--accent);
}
.stat-card {
    text-align: center;
    padding: 2rem 1rem;
    background: linear-gradient(120deg, var(--secondary) 0%, var(--light) 100%);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
.stat-number {
    font-size: 2.7rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 0.5rem;
}
.stat-label {
    font-size: 1rem;
    color: var(--dark);
    text-transform: uppercase;
    letter-spacing: 1px;
}
.loading::before {
    content: '';
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.8);
    z-index: 9999;
}
.loading::after {
    content: 'Loading...';
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    padding: 12px 28px;
    background: var(--primary);
    color: #fff;
    border-radius: 6px;
    font-size: 1.2rem;
    z-index: 10000;
}
.quantity-table {
    font-size: 0.97rem;
}
.quantity-table th {
    background: var(--primary);
    color: #fff;
}
.low-quantity {
    color: var(--accent);
    font-weight: bold;
}
.sync-status {
    position: fixed;
    bottom: 24px;
    right: 24px;
    padding: 12px 20px;
    border-radius: 6px;
    z-index: 1000;
    display: none;
    font-size: 1rem;
    font-weight: 500;
    box-shadow: var(--shadow);
}
.sync-success {
    background: var(--success);
    color: #fff;
}
.sync-error {
    background: var(--accent);
    color: #fff;
}
.sync-loading {
    background: var(--secondary);
    color: #fff;
}
.category-tab {
    cursor: pointer;
    padding: 12px 20px;
    border-radius: 8px 8px 0 0;
    margin-right: 8px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    font-weight: 500;
    transition: background var(--transition), color var(--transition);
}
.category-tab.active {
    background: #fff;
    border-bottom: 1px solid #fff;
    margin-bottom: -1px;
    color: var(--primary);
}
.weight-input-group {
    display: flex;
}
.weight-input-group input {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
.weight-input-group select {
    flex: 0 0 80px;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}
input, select, textarea {
    border-radius: 8px !important;
    border: 1px solid #dee2e6;
    transition: border var(--transition), box-shadow var(--transition);
}
input:focus, select:focus, textarea:focus {
    border-color: var(--secondary);
    box-shadow: 0 0 0 2px rgba(157,170,242,0.15);
}
.modal-content {
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}
.list-group-item {
    border-radius: 6px;
    margin-bottom: 4px;
    background: #f6f7fb;
    border: 1px solid #e3e6f3;
}
::-webkit-scrollbar {
    width: 8px;
    background: #e3e6f3;
}
::-webkit-scrollbar-thumb {
    background: var(--secondary);
    border-radius: 8px;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .sidebar {
        min-height: 100%;
        position: static;
    }
    .stat-card {
        padding: 1.2rem 0.5rem;
    }
}
@media (max-width: 992px) {
    .sidebar {
        position: static;
        height: auto;
        padding-bottom: 1rem;
    }
    .col-md-2.sidebar {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
    .col-md-10 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    .stat-card {
        margin-bottom: 1rem;
    }
    .card {
        margin-bottom: 1.5rem;
    }
}
@media (max-width: 768px) {
    .navbar-brand {
        font-size: 1rem;
    }
    .sidebar .nav-link {
        padding: 0.7rem 1rem;
        font-size: 0.98rem;
    }
    .stat-card {
        padding: 1rem 0.3rem;
        font-size: 0.95rem;
    }
    .card-header h5, h2 {
        font-size: 1.1rem;
    }
    .table-responsive {
        font-size: 0.95rem;
    }
    .category-tab {
        padding: 8px 12px;
        font-size: 0.95rem;
    }
}
@media (max-width: 576px) {
    .navbar {
        padding: 0.5rem 0.7rem;
    }
    .sidebar {
        padding-top: 0.5rem;
    }
    .stat-card {
        padding: 0.7rem 0.2rem;
        font-size: 0.9rem;
    }
    .card {
        margin-bottom: 1rem;
    }
    .modal-content {
        padding: 0.5rem;
    }
    .sync-status {
        bottom: 12px;
        right: 12px;
        padding: 8px 12px;
        font-size: 0.95rem;
    }
    .category-tab {
        padding: 6px 8px;
        font-size: 0.9rem;
    }
}
    </style>
    <!-- Google API scripts -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-boxes me-2"></i>
                Inventory Management System
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <nav class="nav flex-column">
                    <a class="nav-link active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" data-page="products">
                        <i class="fas fa-box me-2"></i> Products Inventory
                    </a>
                    <a class="nav-link" data-page="medicines">
                        <i class="fas fa-pills me-2"></i> Medicines & Vitamins
                    </a>
                    <a class="nav-link" data-page="settings">
                        <i class="fas fa-cog me-2"></i> Settings
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 p-4">
                <!-- Dashboard Page -->
                <div class="page-content active" id="dashboard">
                    <h2 class="mb-4">Dashboard Overview</h2>
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="stat-number" id="totalProducts">0</div>
                                <div class="stat-label">Total Products</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="stat-number" id="totalMedicines">0</div>
                                <div class="stat-label">Medicines</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="stat-number" id="lowStockItems">0</div>
                                <div class="stat-label">Low Stock Items</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card">
                                <div class="stat-number" id="totalWeight">0 kg</div>
                                <div class="stat-label">Total Weight</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Quantity Overview Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-white">
                            <h5>Inventory Quantity Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Products</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm quantity-table">
                                            <thead>
                                                <tr>
                                                    <th>Product Name</th>
                                                    <th>Category</th>
                                                    <th>Quantity</th>
                                                    <th>Weight</th>
                                                    <th>Expiry Date</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productsQuantityList">
                                                <tr>
                                                    <td colspan="4" class="text-center">No products available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Medicines & Vitamins</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm quantity-table">
                                            <thead>
                                                <tr>
                                                    <th>Medicine Name</th>
                                                    <th>Category</th>
                                                    <th>Quantity</th>
                                                    <th>Weight</th>
                                                </tr>
                                            </thead>
                                            <tbody id="medicinesQuantityList">
                                                <tr>
                                                    <td colspan="4" class="text-center">No medicines available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5>Recent Activities</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="recentActivities">
                                <li class="list-group-item">No recent activities</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Products Inventory Page -->
                <div class="page-content" id="products">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Products Inventory</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                            <i class="fas fa-plus me-1"></i> Add Product
                        </button>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search products..." id="productSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="productCategoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="productSort">
                                <option value="name">Sort by Name</option>
                                <option value="quantity">Sort by Quantity</option>
                                <option value="category">Sort by Category</option>
                                <option value="weight">Sort by Weight</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover inventory-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Weight</th>
                                    <th>Actions</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">No products found. Add some products to get started.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Medicines & Vitamins Page -->
                <div class="page-content" id="medicines">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Medicines & Vitamins Inventory</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicineModal">
                            <i class="fas fa-plus me-1"></i> Add Medicine
                        </button>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search medicines..." id="medicineSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="medicineCategoryFilter">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="medicineSort">
                                <option value="name">Sort by Name</option>
                                <option value="quantity">Sort by Quantity</option>
                                <option value="category">Sort by Category</option>
                                <option value="weight">Sort by Weight</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover inventory-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Weight</th>
                                    <th>Expiry Date</th>
                                    <th>Actions</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody id="medicinesTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">No medicines found. Add some medicines to get started.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div class="page-content" id="settings">
                    <h2 class="mb-4">Settings</h2>
                    <div class="card mb-4">
                        <div class="card-header bg-white">
                            <h5>Excel Integration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="excelFile" class="form-label">Import from Excel</label>
                                    <input class="form-control" type="file" id="excelFile" accept=".xlsx, .xls">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Export to Excel</label>
                                    <div>
                                        <button class="btn btn-success" id="exportProducts">
                                            <i class="fas fa-file-export me-1"></i> Export Products
                                        </button>
                                        <button class="btn btn-success" id="exportMedicines">
                                            <i class="fas fa-file-export me-1"></i> Export Medicines
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header bg-white">
                            <h5>Google Sheet Sync</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoSyncToggle" checked>
                                <label class="form-check-label" for="autoSyncToggle">Enable Auto Sync</label>
                            </div>
                            <button class="btn btn-info mb-2" id="syncToGoogleSheet">
                                <i class="fas fa-cloud-upload-alt me-1"></i> Sync to Google Sheet
                            </button>
                            <button class="btn btn-info mb-2" id="loadFromGoogleSheet">
                                <i class="fas fa-cloud-download-alt me-1"></i> Load from Google Sheet
                            </button>
                            <button class="btn btn-outline-primary mb-2" id="googleSignInBtn">
                                <i class="fab fa-google me-1"></i> Sign In with Google
                            </button>
                            <button class="btn btn-outline-danger mb-2" id="googleSignOutBtn" style="display:none;">
                                <i class="fas fa-sign-out-alt me-1"></i> Sign Out
                            </button>
                            <div id="googleStatus" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5>Categories Management</h5>
                            <div class="d-flex mt-2">
                                <div class="category-tab active" data-category-type="product">Product Categories</div>
                                <div class="category-tab" data-category-type="medicine">Medicine Categories</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="newCategory" class="form-label">Add New Category</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="newCategory" placeholder="Category name">
                                            <button class="btn btn-primary" id="addCategoryBtn">Add</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Existing Categories</label>
                                    <ul class="list-group" id="categoriesList">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">Category</label>
                            <select class="form-select" id="productCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="initialQuantity" class="form-label">Initial Quantity</label>
                            <input type="number" class="form-control" id="initialQuantity" min="0" value="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="productWeight" class="form-label">Weight</label>
                            <div class="weight-input-group">
                                <input type="number" class="form-control" id="productWeight" min="0" step="0.01" value="0" required>
                                <select class="form-select" id="productWeightUnit">
                                    <option value="kg">kg</option>
                                    <option value="g">g</option>
                                    <option value="mg">mg</option>
                                    <option value="lb">lb</option>
                                    <option value="oz">oz</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date (Optional)</label>
                            <input type="date" class="form-control" id="expiryDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Medicine Modal -->
    <div class="modal fade" id="addMedicineModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Medicine/Vitamin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addMedicineForm">
                        <div class="mb-3">
                            <label for="medicineName" class="form-label">Medicine Name</label>
                            <input type="text" class="form-control" id="medicineName" required>
                        </div>
                        <div class="mb-3">
                            <label for="medicineType" class="form-label">Type</label>
                            <select class="form-select" id="medicineType" required>
                                <option value="Medicine">Medicine</option>
                                <option value="Vitamin">Vitamin</option>
                                <option value="Supplement">Supplement</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="medicineCategory" class="form-label">Category</label>
                            <select class="form-select" id="medicineCategory" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="medicineQuantity" class="form-label">Initial Quantity</label>
                            <input type="number" class="form-control" id="medicineQuantity" min="0" value="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="medicineWeight" class="form-label">Weight</label>
                            <div class="weight-input-group">
                                <input type="number" class="form-control" id="medicineWeight" min="0" step="0.01" value="0" required>
                                <select class="form-select" id="medicineWeightUnit">
                                    <option value="kg">kg</option>
                                    <option value="g">g</option>
                                    <option value="mg">mg</option>
                                    <option value="lb">lb</option>
                                    <option value="oz">oz</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date (Optional)</label>
                            <input type="date" class="form-control" id="expiryDate">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMedicineBtn">Save Medicine</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Quantity Modal -->
    <div class="modal fade" id="adjustQuantityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustModalTitle">Adjust Quantity</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Current Quantity: <span id="currentQuantityDisplay">0</span></p>
                    <div class="mb-3">
                        <label for="adjustmentAmount" class="form-label">Adjustment Amount</label>
                        <input type="number" class="formcontrol" id="adjustmentAmount" min="1" value="1" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="adjustmentType" id="addStock" value="add" checked>
                        <label class="form-check-label" for="addStock">
                            Add to Stock
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="adjustmentType" id="removeStock" value="remove">
                        <label class="form-check-label" for="removeStock">
                            Remove from Stock
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmAdjustment">Confirm Adjustment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div class="sync-status" id="syncStatus"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Google API Setup
    const CLIENT_ID = '784684959444-94639fhibgtfgs5panlo1sq9a5mh8f6s.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCrtb0KACcthRmDLR0pKvSpTw1UHRX_FpQ';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SPREADSHEET_ID = '1nT6qcCqPr48ia-TxaLx1xjyqnFmubxfkUXZERznUBc4';

    let gapiLoaded = false;
    let gisLoaded = false;
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let googleSignedIn = false;
    let autoSyncEnabled = true;
    let syncInProgress = false;

    function updateGoogleStatus(msg) {
        document.getElementById('googleStatus').textContent = msg;
    }

    function showSignInBtn(show) {
        document.getElementById('googleSignInBtn').style.display = show ? '' : 'none';
        document.getElementById('googleSignOutBtn').style.display = show ? 'none' : '';
    }

    function gapiLoadedCallback() {
        gapiLoaded = true;
        maybeEnableGoogleButtons();
    }
    function gisLoadedCallback() {
        gisLoaded = true;
        maybeEnableGoogleButtons();
    }
    function maybeEnableGoogleButtons() {
        if (gapiLoaded && gisLoaded) {
            document.getElementById('googleSignInBtn').disabled = false;
        }
    }

    // Load Google API
    window.onload = function() {
        gapi.load('client', initializeGapiClient);
    };

    function initializeGapiClient() {
        gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        }).then(function () {
            gapiInited = true;
            updateGoogleStatus('Google API loaded.');
        }, function(error) {
            updateGoogleStatus('Google API failed to load.');
        });
    }

    // Google Identity Services
    document.getElementById('googleSignInBtn').addEventListener('click', function() {
        if (!tokenClient) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    gapi.client.setToken(tokenResponse);
                    googleSignedIn = true;
                    showSignInBtn(false);
                    updateGoogleStatus('Signed in to Google.');
                    // Auto sync after sign in
                    if (autoSyncEnabled) {
                        autoSyncToGoogleSheet();
                    }
                },
            });
        }
        tokenClient.requestAccessToken();
    });

    document.getElementById('googleSignOutBtn').addEventListener('click', function() {
        googleSignedIn = false;
        gapi.client.setToken('');
        showSignInBtn(true);
        updateGoogleStatus('Signed out.');
    });

    // Auto sync toggle
    document.getElementById('autoSyncToggle').addEventListener('change', function() {
        autoSyncEnabled = this.checked;
        if (autoSyncEnabled && googleSignedIn) {
            autoSyncToGoogleSheet();
        }
    });

    // Show sync status
    function showSyncStatus(message, type) {
        const statusElement = document.getElementById('syncStatus');
        statusElement.textContent = message;
        statusElement.className = 'sync-status';
        
        if (type === 'success') {
            statusElement.classList.add('sync-success');
        } else if (type === 'error') {
            statusElement.classList.add('sync-error');
        } else if (type === 'loading') {
            statusElement.classList.add('sync-loading');
        }
        
        statusElement.style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 3000);
    }

    // Google Sheets Sync
    document.getElementById('syncToGoogleSheet').addEventListener('click', async function() {
        if (!googleSignedIn) {
            alert('Please sign in with Google first.');
            return;
        }
        updateGoogleStatus('Syncing...');
        showSyncStatus('Syncing to Google Sheet...', 'loading');
        await syncToGoogleSheet();
    });

    document.getElementById('loadFromGoogleSheet').addEventListener('click', async function() {
        if (!googleSignedIn) {
            alert('Please sign in with Google first.');
            return;
        }
        updateGoogleStatus('Loading...');
        showSyncStatus('Loading from Google Sheet...', 'loading');
        try {
            // Load products from Sheet1
            const productsRes = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet1!A1:G1000' // Updated to include expiry date column
            });
            
            // Load medicines from Sheet2
            const medicinesRes = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet2!A1:G1000'
            });
            
            // Load vitamins from Sheet3
            const vitaminsRes = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet3!A1:G1000'
            });
            
            // Load supplements from Sheet4
            const supplementsRes = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet4!A1:G1000'
            });
            
            const productsData = productsRes.result.values || [];
            const medicinesData = medicinesRes.result.values || [];
            const vitaminsData = vitaminsRes.result.values || [];
            const supplementsData = supplementsRes.result.values || [];
            
            if (productsData.length < 2 && medicinesData.length < 2 && vitaminsData.length < 2 && supplementsData.length < 2) {
                alert('No data found in Google Sheet.');
                updateGoogleStatus('No data found.');
                showSyncStatus('No data found in Google Sheet', 'error');
                return;
            }
            
            // Clear existing data
            inventoryData.products = [];
            inventoryData.medicines = [];
            
            // Process products from Sheet1
            if (productsData.length > 1) {
                productsData.shift(); // Remove headers
                productsData.forEach(row => {
                    inventoryData.products.push({
                        name: row[0],
                        category: row[1],
                        quantity: Number(row[2]),
                        weight: Number(row[3] || 0),
                        weightUnit: row[4] || 'kg', // Default to kg if not specified
                        expiryDate: row[5] || 'N/A', // Get expiry date from row 5
                        lastUpdated: row[6],
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            // Process medicines from Sheet2
            if (medicinesData.length > 1) {
                medicinesData.shift(); // Remove headers
                medicinesData.forEach(row => {
                    inventoryData.medicines.push({
                        name: row[0],
                        type: "Medicine",
                        category: row[1],
                        quantity: Number(row[2]),
                        weight: Number(row[3] || 0),
                        weightUnit: row[4] || 'kg', // Default to kg if not specified
                        expiryDate: row[5],
                        lastUpdated: row[6],
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            // Process vitamins from Sheet3
            if (vitaminsData.length > 1) {
                vitaminsData.shift(); // Remove headers
                vitaminsData.forEach(row => {
                    inventoryData.medicines.push({
                        name: row[0],
                        type: "Vitamin",
                        category: row[1],
                        quantity: Number(row[2]),
                        weight: Number(row[3] || 0),
                        weightUnit: row[4] || 'kg', // Default to kg if not specified
                        expiryDate: row[5],
                        lastUpdated: row[6],
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            // Process supplements from Sheet4
            if (supplementsData.length > 1) {
                supplementsData.shift(); // Remove headers
                supplementsData.forEach(row => {
                    inventoryData.medicines.push({
                        name: row[0],
                        type: "Supplement",
                        category: row[1],
                        quantity: Number(row[2]),
                        weight: Number(row[3] || 0),
                        weightUnit: row[4] || 'kg', // Default to kg if not specified
                        expiryDate: row[5],
                        lastUpdated: row[6],
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            saveToLocalStorage();
            renderProductsTable();
            renderMedicinesTable();
            updateDashboard();
            renderQuantityOverview();
            alert("Loaded from Google Sheet!");
            updateGoogleStatus('Loaded from Google Sheet!');
            showSyncStatus('Loaded from Google Sheet!', 'success');
        } catch (err) {
            updateGoogleStatus('Load failed.');
            showSyncStatus('Load failed: ' + err.result.error.message, 'error');
            alert('Load failed: ' + err.result.error.message);
        }
    });

    // Auto sync function
    async function autoSyncToGoogleSheet() {
        if (!googleSignedIn || !autoSyncEnabled || syncInProgress) return;
        
        syncInProgress = true;
        try {
            await syncToGoogleSheet();
        } catch (error) {
            console.error("Auto sync failed:", error);
        } finally {
            syncInProgress = false;
        }
    }

    // Main sync function
    async function syncToGoogleSheet() {
        if (!googleSignedIn) return;
        
        try {
            // Prepare data for Sheet1 (Products)
            const productsHeaders = ["Name", "Category", "Quantity", "Weight", "Weight Unit", "Expiry Date", "Last Updated"];
            const productsData = inventoryData.products.map(p => [
                p.name, 
                p.category, 
                p.quantity, 
                p.weight, 
                p.weightUnit, 
                p.expiryDate || "N/A",  // Include expiry date
                p.lastUpdated
            ]);
            
            // Prepare data for Sheet2 (Medicines)
            const medicinesHeaders = ["Name", "Category", "Quantity", "Weight", "Weight Unit", "Expiry Date", "Last Updated"];
            const medicinesData = inventoryData.medicines
                .filter(m => m.type === "Medicine")
                .map(m => [
                    m.name, 
                    m.category, 
                    m.quantity, 
                    m.weight, 
                    m.weightUnit, 
                    m.expiryDate, 
                    m.lastUpdated
                ]);
            
            // Prepare data for Sheet3 (Vitamins)
            const vitaminsData = inventoryData.medicines
                .filter(m => m.type === "Vitamin")
                .map(m => [
                    m.name, 
                    m.category, 
                    m.quantity, 
                    m.weight, 
                    m.weightUnit, 
                    m.expiryDate, 
                    m.lastUpdated
                ]);
            
            // Prepare data for Sheet4 (Supplements)
            const supplementsData = inventoryData.medicines
                .filter(m => m.type === "Supplement")
                .map(m => [
                    m.name, 
                    m.category, 
                    m.quantity, 
                    m.weight, 
                    m.weightUnit, 
                    m.expiryDate, 
                    m.lastUpdated
                ]);
            
            // Update Sheet1 (Products)
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet1!A1:G1000', // Updated to include expiry date column
                valueInputOption: 'RAW',
                resource: { values: [productsHeaders, ...productsData] }
            });
            
            // Update Sheet2 (Medicines)
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet2!A1',
                valueInputOption: 'RAW',
                resource: { values: [medicinesHeaders, ...medicinesData] }
            });
            
            // Update Sheet3 (Vitamins)
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet3!A1',
                valueInputOption: 'RAW',
                resource: { values: [medicinesHeaders, ...vitaminsData] }
            });
            
            // Update Sheet4 (Supplements)
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet4!A1',
                valueInputOption: 'RAW',
                resource: { values: [medicinesHeaders, ...supplementsData] }
            });
            
            updateGoogleStatus('Synced to Google Sheet!');
            showSyncStatus('Synced to Google Sheet!', 'success');
        } catch (err) {
            updateGoogleStatus('Sync failed.');
            showSyncStatus('Sync failed: ' + err.result.error.message, 'error');
            alert('Sync failed: ' + err.result.error.message);
        }
    }
    </script>
    <script>
        // Inventory Data Structure
    let inventoryData = {
        products: [],
        medicines: [],
        productCategories: [],
        medicineCategories: [],
        activities: []
    };
    let currentAdjustmentItem = null;
    let currentAdjustmentType = '';
    let currentCategoryType = 'product'; // Default to product categories

    // Weight conversion functions
    function convertToKg(weight, unit) {
        switch(unit) {
            case 'kg': return weight;
            case 'g': return weight / 1000;
            case 'mg': return weight / 1000000;
            case 'lb': return weight * 0.453592;
            case 'oz': return weight * 0.0283495;
            default: return weight;
        }
    }

    function formatWeight(weight, unit) {
        return `${weight} ${unit}`;
    }

    // Load data from localStorage
    loadFromLocalStorage();
    renderProductsTable();
    renderMedicinesTable();
    renderCategoriesList();
    populateCategoryDropdowns();
    updateDashboard();
    renderActivities();
    renderQuantityOverview();

    // Category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentCategoryType = this.dataset.categoryType;
            renderCategoriesList();
        });
    });

    // Sidebar navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function() {
            showPage(this.dataset.page);
        });
    });

    function showPage(page) {
        document.querySelectorAll('.page-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(page).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        document.querySelector(`.nav-link[data-page="${page}"]`).classList.add('active');
    }

    // Dashboard stats
    function updateDashboard() {
        document.getElementById('totalProducts').textContent = inventoryData.products.length;
        document.getElementById('totalMedicines').textContent = inventoryData.medicines.length;
        document.getElementById('lowStockItems').textContent =
            inventoryData.products.filter(p => p.quantity <= 5).length +
            inventoryData.medicines.filter(m => m.quantity <= 5).length;
        
        // Calculate total weight in kg
        const totalProductsWeight = inventoryData.products.reduce((sum, p) => {
            return sum + (convertToKg(p.weight, p.weightUnit || 'kg') * p.quantity);
        }, 0);
        
        const totalMedicinesWeight = inventoryData.medicines.reduce((sum, m) => {
            return sum + (convertToKg(m.weight, m.weightUnit || 'kg') * m.quantity);
        }, 0);
        
        const totalWeight = totalProductsWeight + totalMedicinesWeight;
        document.getElementById('totalWeight').textContent = totalWeight.toFixed(2) + ' kg';
    }

    // New function to render quantity overview
    function renderQuantityOverview() {
        const productsList = document.getElementById('productsQuantityList');
        const medicinesList = document.getElementById('medicinesQuantityList');
        
        // Clear existing content
        productsList.innerHTML = '';
        medicinesList.innerHTML = '';
        
        // Render products
        if (inventoryData.products.length === 0) {
            productsList.innerHTML = '<tr><td colspan="5" class="text-center">No products available</td></tr>';
        } else {
            inventoryData.products.forEach(product => {
                const row = document.createElement('tr');
                const quantityClass = product.quantity <= 5 ? 'low-quantity' : '';
                const totalWeight = product.weight * product.quantity;
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td class="${quantityClass}">${product.quantity}</td>
                    <td>${formatWeight(totalWeight, product.weightUnit)}</td>
                    <td>${product.expiryDate || 'N/A'}</td>
                `;
                productsList.appendChild(row);
            });
        }
        
        // Render medicines
        if (inventoryData.medicines.length === 0) {
            medicinesList.innerHTML = '<tr><td colspan="4" class="text-center">No medicines available</td></tr>';
        } else {
            inventoryData.medicines.forEach(medicine => {
                const row = document.createElement('tr');
                const quantityClass = medicine.quantity <= 5 ? 'low-quantity' : '';
                const totalWeight = medicine.weight * medicine.quantity;
                row.innerHTML = `
                    <td>${medicine.name}</td>
                    <td>${medicine.category}</td>
                    <td class="${quantityClass}">${medicine.quantity}</td>
                    <td>${formatWeight(totalWeight, medicine.weightUnit)}</td>
                `;
                medicinesList.appendChild(row);
            });
        }
    }

    // Activities
    function addActivity(message) {
        const activity = {
            timestamp: new Date().toLocaleString(),
            message: message
        };
        inventoryData.activities.unshift(activity);
        if (inventoryData.activities.length > 10) {
            inventoryData.activities.pop();
        }
        saveToLocalStorage();
        renderActivities();
        
        // Auto sync after activity
        autoSyncToGoogleSheet();
    }

    function renderActivities() {
        const activitiesList = document.getElementById('recentActivities');
        activitiesList.innerHTML = '';
        if (inventoryData.activities.length === 0) {
            activitiesList.innerHTML = '<li class="list-group-item">No recent activities</li>';
            return;
        }
        inventoryData.activities.forEach(activity => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${activity.timestamp}: ${activity.message}`;
            activitiesList.appendChild(li);
        });
    }

    // Products
    document.getElementById('saveProductBtn').addEventListener('click', function() {
        const name = document.getElementById('productName').value.trim();
        const category = document.getElementById('productCategory').value;
        const quantity = parseInt(document.getElementById('initialQuantity').value);
        const weight = parseFloat(document.getElementById('productWeight').value);
        const weightUnit = document.getElementById('productWeightUnit').value;
        const expiryDate = document.getElementById('expiryDate').value || 'N/A';
        
        if (!name || !category || isNaN(quantity) || quantity < 0 || isNaN(weight) || weight < 0) {
            alert('Please fill in all fields correctly');
            return;
        }
        
        const newProduct = {
            id: Date.now(),
            name: name,
            category: category,
            quantity: quantity,
            weight: weight,
            weightUnit: weightUnit,
            expiryDate: expiryDate,
            lastUpdated: new Date().toLocaleString()
        };
        
        inventoryData.products.push(newProduct);
        addActivity(`Added product: ${name}`);
        saveToLocalStorage();
        renderProductsTable();
        updateDashboard();
        renderQuantityOverview();
        document.getElementById('addProductForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
    });

    function renderProductsTable(products = inventoryData.products) {
        const tableBody = document.getElementById('productsTableBody');
        tableBody.innerHTML = '';
        if (products.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No products found. Add some products to get started.</td></tr>';
            return;
        }
        products.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>${product.quantity}</td>
                <td>${formatWeight(product.weight, product.weightUnit)}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="showAdjustQuantityModal(${product.id}, 'product')">
                        <i class="fas fa-edit"></i> Adjust
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
                <td>${product.lastUpdated}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    window.showAdjustQuantityModal = function(id, type) {
        currentAdjustmentItem = inventoryData[type + 's'].find(item => item.id === id);
        if (!currentAdjustmentItem) return;
        document.getElementById('currentQuantityDisplay').textContent = currentAdjustmentItem.quantity;
        currentAdjustmentType = type;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('adjustQuantityModal')).show();
    };

    window.deleteProduct = function(id) {
        const product = inventoryData.products.find(p => p.id === id);
        if (!product) return;
        if (!confirm(`Delete product "${product.name}"?`)) return;
        inventoryData.products = inventoryData.products.filter(p => p.id !== id);
        addActivity(`Deleted product: ${product.name}`);
        saveToLocalStorage();
        renderProductsTable();
        updateDashboard();
        renderQuantityOverview();
    };

    // Medicines
    document.getElementById('saveMedicineBtn').addEventListener('click', function() {
        const name = document.getElementById('medicineName').value.trim();
        const type = document.getElementById('medicineType').value;
        const category = document.getElementById('medicineCategory').value;
        const quantity = parseInt(document.getElementById('medicineQuantity').value);
        const weight = parseFloat(document.getElementById('medicineWeight').value);
        const weightUnit = document.getElementById('medicineWeightUnit').value;
        const expiryDate = document.getElementById('expiryDate').value || 'N/A';
        
        if (!name || !category || isNaN(quantity) || quantity < 0 || isNaN(weight) || weight < 0) {
            alert('Please fill in all fields correctly');
            return;
        }
        
        const newMedicine = {
            id: Date.now(),
            name: name,
            type: type,
            category: category,
            quantity: quantity,
            weight: weight,
            weightUnit: weightUnit,
            expiryDate: expiryDate,
            lastUpdated: new Date().toLocaleString()
        };
        
        inventoryData.medicines.push(newMedicine);
        addActivity(`Added ${type.toLowerCase()}: ${name}`);
        saveToLocalStorage();
        renderMedicinesTable();
        updateDashboard();
        renderQuantityOverview();
        document.getElementById('addMedicineForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('addMedicineModal')).hide();
    });

    function renderMedicinesTable(medicines = inventoryData.medicines) {
        const tableBody = document.getElementById('medicinesTableBody');
        tableBody.innerHTML = '';
        if (medicines.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">No medicines found. Add some medicines to get started.</td></tr>';
            return;
        }
        medicines.forEach(medicine => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${medicine.name}</td>
                <td>${medicine.type}</td>
                <td>${medicine.category}</td>
                <td>${medicine.quantity}</td>
                <td>${formatWeight(medicine.weight, medicine.weightUnit)}</td>
                <td>${medicine.expiryDate}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="showAdjustQuantityModal(${medicine.id}, 'medicine')">
                        <i class="fas fa-edit"></i> Adjust
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteMedicine(${medicine.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
                <td>${medicine.lastUpdated}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    window.deleteMedicine = function(id) {
        const medicine = inventoryData.medicines.find(m => m.id === id);
        if (!medicine) return;
        if (!confirm(`Delete ${medicine.type.toLowerCase()} "${medicine.name}"?`)) return;
        inventoryData.medicines = inventoryData.medicines.filter(m => m.id !== id);
        addActivity(`Deleted ${medicine.type.toLowerCase()}: ${medicine.name}`);
        saveToLocalStorage();
        renderMedicinesTable();
        updateDashboard();
        renderQuantityOverview();
    };

    // Adjust Quantity
    document.getElementById('confirmAdjustment').addEventListener('click', function() {
        if (!currentAdjustmentItem) return;
        const amount = parseInt(document.getElementById('adjustmentAmount').value);
        const isAdd = document.getElementById('addStock').checked;
        if (isNaN(amount) || amount <= 0) {
            alert('Please enter a valid amount');
            return;
        }
        if (isAdd) {
            currentAdjustmentItem.quantity += amount;
            addActivity(`Added ${amount} to ${currentAdjustmentItem.name}`);
        } else {
            if (currentAdjustmentItem.quantity < amount) {
                alert('Insufficient stock to remove this amount');
                return;
            }
            currentAdjustmentItem.quantity -= amount;
            addActivity(`Removed ${amount} from ${currentAdjustmentItem.name}`);
        }
        currentAdjustmentItem.lastUpdated = new Date().toLocaleString();
        saveToLocalStorage();
        renderProductsTable();
        renderMedicinesTable();
        updateDashboard();
        renderQuantityOverview();
        bootstrap.Modal.getInstance(document.getElementById('adjustQuantityModal')).hide();
    });

    // Categories
    document.getElementById('addCategoryBtn').addEventListener('click', function() {
        const newCategory = document.getElementById('newCategory').value.trim();
        if (!newCategory) {
            alert('Please enter a category name');
            return;
        }
        
        // Determine which category array to use
        const targetCategories = currentCategoryType === 'product' 
            ? inventoryData.productCategories 
            : inventoryData.medicineCategories;
            
        if (targetCategories.includes(newCategory)) {
            alert('Category already exists');
            return;
        }
        
        targetCategories.push(newCategory);
        addActivity(`Added ${currentCategoryType} category: ${newCategory}`);
        saveToLocalStorage();
        renderCategoriesList();
        populateCategoryDropdowns();
        document.getElementById('newCategory').value = '';
    });

    function renderCategoriesList() {
        const categoriesList = document.getElementById('categoriesList');
        categoriesList.innerHTML = '';
        
        // Get the appropriate category list based on current selection
        const categories = currentCategoryType === 'product' 
            ? inventoryData.productCategories 
            : inventoryData.medicineCategories;
            
        if (categories.length === 0) {
            categoriesList.innerHTML = '<li class="list-group-item">No categories yet.</li>';
            return;
        }
        
        categories.forEach(category => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = category;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-outline-danger';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = function() {
                deleteCategory(category, currentCategoryType);
            };
            
            li.appendChild(deleteBtn);
            categoriesList.appendChild(li);
        });
    }

    function deleteCategory(category, type) {
        if (!confirm(`Delete category "${category}"? This will not affect existing items with this category.`)) return;
        
        if (type === 'product') {
            inventoryData.productCategories = inventoryData.productCategories.filter(c => c !== category);
        } else {
            inventoryData.medicineCategories = inventoryData.medicineCategories.filter(c => c !== category);
        }
        
        addActivity(`Deleted ${type} category: ${category}`);
        saveToLocalStorage();
        renderCategoriesList();
        populateCategoryDropdowns();
    }

    function populateCategoryDropdowns() {
        // Product category dropdowns
        const productCategorySelect = document.getElementById('productCategory');
        const productCategoryFilter = document.getElementById('productCategoryFilter');
        
        productCategorySelect.innerHTML = '<option value="">Select Category</option>';
        productCategoryFilter.innerHTML = '<option value="">All Categories</option>';
        
        inventoryData.productCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            productCategorySelect.appendChild(option.cloneNode(true));
            productCategoryFilter.appendChild(option.cloneNode(true));
        });
        
        // Medicine category dropdowns
        const medicineCategorySelect = document.getElementById('medicineCategory');
        const medicineCategoryFilter = document.getElementById('medicineCategoryFilter');
        
        medicineCategorySelect.innerHTML = '<option value="">Select Category</option>';
        medicineCategoryFilter.innerHTML = '<option value="">All Categories</option>';
        
        inventoryData.medicineCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            medicineCategorySelect.appendChild(option.cloneNode(true));
            medicineCategoryFilter.appendChild(option.cloneNode(true));
        });
    }

    // Filtering and Sorting
    document.getElementById('productSearch').addEventListener('input', filterProducts);
    document.getElementById('productCategoryFilter').addEventListener('change', filterProducts);
    document.getElementById('productSort').addEventListener('change', filterProducts);

    function filterProducts() {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('productCategoryFilter').value;
        const sortOption = document.getElementById('productSort').value;
        let filteredProducts = inventoryData.products.filter(p =>
            p.name.toLowerCase().includes(searchTerm) &&
            (categoryFilter === '' || p.category === categoryFilter)
        );
        if (sortOption === 'name') {
            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortOption === 'quantity') {
            filteredProducts.sort((a, b) => a.quantity - b.quantity);
        } else if (sortOption === 'category') {
            filteredProducts.sort((a, b) => a.category.localeCompare(b.category));
        } else if (sortOption === 'weight') {
            filteredProducts.sort((a, b) => convertToKg(a.weight, a.weightUnit) - convertToKg(b.weight, b.weightUnit));
        }
        renderProductsTable(filteredProducts);
    }

    document.getElementById('medicineSearch').addEventListener('input', filterMedicines);
    document.getElementById('medicineCategoryFilter').addEventListener('change', filterMedicines);
    document.getElementById('medicineSort').addEventListener('change', filterMedicines);

    function filterMedicines() {
        const searchTerm = document.getElementById('medicineSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('medicineCategoryFilter').value;
        const sortOption = document.getElementById('medicineSort').value;
        let filteredMedicines = inventoryData.medicines.filter(m =>
            m.name.toLowerCase().includes(searchTerm) &&
            (categoryFilter === '' || m.category === categoryFilter)
        );
        if (sortOption === 'name') {
            filteredMedicines.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortOption === 'quantity') {
            filteredMedicines.sort((a, b) => a.quantity - b.quantity);
        } else if (sortOption === 'category') {
            filteredMedicines.sort((a, b) => a.category.localeCompare(b.category));
        } else if (sortOption === 'weight') {
            filteredMedicines.sort((a, b) => convertToKg(a.weight, a.weightUnit) - convertToKg(b.weight, b.weightUnit));
        }
        renderMedicinesTable(filteredMedicines);
    }

    // Excel Export/Import
    document.getElementById('exportProducts').addEventListener('click', function() {
        exportToExcel('products');
    });
    document.getElementById('exportMedicines').addEventListener('click', function() {
        exportToExcel('medicines');
    });

    function exportToExcel(type) {
        const data = type === 'products' ? inventoryData.products : inventoryData.medicines;
        if (data.length === 0) {
            alert('No data to export');
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, type.charAt(0).toUpperCase() + type.slice(1));
        XLSX.writeFile(workbook, `${type}.xlsx`);
    }

    document.getElementById('excelFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            if (jsonData.length === 0) {
                alert('No data found in the file');
                return;
            }
            if (firstSheetName.toLowerCase().includes('product')) {
                // Add default weightUnit and expiryDate if not present
                const productsWithUnits = jsonData.map(p => ({
                    ...p,
                    weightUnit: p.weightUnit || 'kg',
                    expiryDate: p.expiryDate || 'N/A'
                }));
                inventoryData.products.push(...productsWithUnits);
                addActivity(`Imported ${jsonData.length} products from Excel`);
                renderProductsTable();
                renderQuantityOverview();
            } else if (firstSheetName.toLowerCase().includes('medicine')) {
                // Add default weightUnit if not present
                const medicinesWithUnits = jsonData.map(m => ({
                    ...m,
                    weightUnit: m.weightUnit || 'kg'
                }));
                inventoryData.medicines.push(...medicinesWithUnits);
                addActivity(`Imported ${jsonData.length} medicines from Excel`);
                renderMedicinesTable();
                renderQuantityOverview();
            } else {
                alert('Unsupported file format');
                return;
            }
            saveToLocalStorage();
            updateDashboard();
        };
        reader.readAsArrayBuffer(file);
    });

    // Local Storage
    function loadFromLocalStorage() {
        const data = localStorage.getItem('inventoryData');
        if (data) {
            inventoryData = JSON.parse(data);
            
            // Handle migration from old data structure
            if (inventoryData.categories && !inventoryData.productCategories) {
                inventoryData.productCategories = inventoryData.categories;
                delete inventoryData.categories;
            }
            if (!inventoryData.medicineCategories) {
                inventoryData.medicineCategories = [];
            }
            
            // Add default weightUnit and expiryDate for existing items
            inventoryData.products.forEach(p => {
                if (!p.weightUnit) p.weightUnit = 'kg';
                if (!p.expiryDate) p.expiryDate = 'N/A';
            });
            inventoryData.medicines.forEach(m => {
                if (!m.weightUnit) m.weightUnit = 'kg';
            });
        }
    }

    function saveToLocalStorage() {
        localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
    }

    // Initial page load
    showPage('dashboard');
    </script>
</body>
</html>